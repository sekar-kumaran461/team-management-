{% extends 'base.html' %}

{% block title %}Tasks - TeamLearn{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl shadow-lg p-8 text-white relative overflow-hidden">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full"></div>
        <div class="absolute bottom-0 left-0 -mb-8 -ml-8 w-32 h-32 bg-white opacity-5 rounded-full"></div>
        <div class="relative flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">Task Management</h1>
                <p class="text-purple-100 mt-2">Organize your daily challenges and track progress</p>
                <div class="flex items-center mt-4 space-x-4">
                    <div class="flex items-center">
                        <i class="fas fa-calendar text-purple-200 mr-2"></i>
                        <span class="text-purple-100">{{ tasks.count }} tasks today</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-clock text-purple-200 mr-2"></i>
                        <span class="text-purple-100">Last updated: {{ last_updated|default:"Never" }}</span>
                    </div>
                </div>
            </div>
            <div class="flex space-x-3">
                {% if user.can_manage_tasks %}
                <a href="{% url 'tasks:task-create' %}" class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium rounded-lg text-purple-600 bg-white hover:bg-gray-50 transition-all duration-200 shadow-md hover:shadow-lg">
                    <i class="fas fa-plus mr-2"></i>
                    Create Task
                </a>
                <a href="{% url 'tasks:bulk-upload' %}" class="inline-flex items-center px-6 py-3 border border-white border-opacity-30 text-sm font-medium rounded-lg text-white bg-white bg-opacity-20 hover:bg-opacity-30 transition-all duration-200">
                    <i class="fas fa-upload mr-2"></i>
                    Bulk Upload
                </a>
                <a href="{% url 'tasks:recurring-templates' %}" class="inline-flex items-center px-6 py-3 border border-white border-opacity-30 text-sm font-medium rounded-lg text-white bg-white bg-opacity-20 hover:bg-opacity-30 transition-all duration-200">
                    <i class="fas fa-template mr-2"></i>
                    Templates
                </a>
                {% endif %}
                <a href="{% url 'tasks:task-calendar' %}" class="inline-flex items-center px-6 py-3 border border-white border-opacity-30 text-sm font-medium rounded-lg text-white bg-white bg-opacity-20 hover:bg-opacity-30 transition-all duration-200">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    Calendar View
                </a>
                <a href="{% url 'tasks:recurring-tasks' %}" class="inline-flex items-center px-6 py-3 border border-white border-opacity-30 text-sm font-medium rounded-lg text-white bg-white bg-opacity-20 hover:bg-opacity-30 transition-all duration-200">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Recurring Tasks
                </a>
            </div>
        </div>
    </div>

    <!-- Quick Filters and Search -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <!-- Search Bar -->
            <div class="flex-1 lg:mr-6">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" placeholder="Search tasks..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
            </div>
            
            <!-- Filter Buttons -->
            <div class="flex flex-wrap gap-2">
                <button class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors duration-200 filter-btn active" data-filter="all">
                    <i class="fas fa-list mr-1"></i> All
                </button>
                <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200 filter-btn" data-filter="todo">
                    <i class="fas fa-circle mr-1"></i> To Do
                </button>
                <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200 filter-btn" data-filter="in_progress">
                    <i class="fas fa-play mr-1"></i> In Progress
                </button>
                <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200 filter-btn" data-filter="completed">
                    <i class="fas fa-check mr-1"></i> Completed
                </button>
                <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200 filter-btn" data-filter="overdue">
                    <i class="fas fa-exclamation-triangle mr-1"></i> Overdue
                </button>
            </div>
            
            <!-- View Toggle -->
            <div class="flex border border-gray-300 rounded-lg overflow-hidden">
                <button class="px-3 py-2 bg-purple-600 text-white view-toggle active" data-view="card">
                    <i class="fas fa-th-large"></i>
                </button>
                <button class="px-3 py-2 bg-white text-gray-700 hover:bg-gray-50 view-toggle" data-view="list">
                    <i class="fas fa-list"></i>
                </button>
                <button class="px-3 py-2 bg-white text-gray-700 hover:bg-gray-50 view-toggle" data-view="kanban">
                    <i class="fas fa-columns"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Task Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-tasks text-blue-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-gray-900">Total Tasks</h3>
                    <div class="text-3xl font-bold text-gray-900">{{ task_stats.total|default:0 }}</div>
                    <p class="text-sm text-gray-500">All time tasks</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-gray-900">Completed</h3>
                    <div class="text-3xl font-bold text-gray-900">{{ task_stats.completed|default:0 }}</div>
                    <p class="text-sm text-gray-500">Finished tasks</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-gray-900">In Progress</h3>
                    <div class="text-3xl font-bold text-gray-900">{{ task_stats.in_progress|default:0 }}</div>
                    <p class="text-sm text-gray-500">Active tasks</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-percentage text-purple-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-gray-900">Success Rate</h3>
                    <div class="text-3xl font-bold text-gray-900">{{ task_stats.success_rate|default:0 }}%</div>
                    <p class="text-sm text-gray-500">Completion rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Content -->
    <div class="bg-white rounded-xl shadow-md">
        <!-- Task Toolbar -->
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                <div class="flex items-center space-x-4">
                    <h2 class="text-lg font-semibold text-gray-900">Your Tasks</h2>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        {{ tasks.count }} total
                    </span>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="bulkSelect()" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-check-square mr-2"></i>
                        Bulk Actions
                    </button>
                    <button onclick="exportTasks()" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-download mr-2"></i>
                        Export
                    </button>
                    <button onclick="refreshTasks()" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <form method="GET" class="space-y-4">
            <!-- First row: Search and Sort -->
            <div class="flex flex-col lg:flex-row gap-4">
                <div class="flex-1">
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search Tasks</label>
                    <input type="text" id="search" name="search" value="{{ request.GET.search }}" placeholder="Search tasks..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="sort" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                    <select id="sort" name="sort" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="due_date" {% if current_sort == 'due_date' %}selected{% endif %}>Due Date (Earliest)</option>
                        <option value="due_date_desc" {% if current_sort == 'due_date_desc' %}selected{% endif %}>Due Date (Latest)</option>
                        <option value="created" {% if current_sort == 'created' %}selected{% endif %}>Created (Newest)</option>
                        <option value="created_asc" {% if current_sort == 'created_asc' %}selected{% endif %}>Created (Oldest)</option>
                        <option value="title" {% if current_sort == 'title' %}selected{% endif %}>Title (A-Z)</option>
                        <option value="title_desc" {% if current_sort == 'title_desc' %}selected{% endif %}>Title (Z-A)</option>
                        <option value="priority" {% if current_sort == 'priority' %}selected{% endif %}>Priority</option>
                        <option value="status" {% if current_sort == 'status' %}selected{% endif %}>Status</option>
                    </select>
                </div>
            </div>
            
            <!-- Second row: Category filters -->
            <div class="flex flex-wrap gap-4">
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="category" name="category" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Categories</option>
                        <option value="DSA" {% if request.GET.category == 'DSA' %}selected{% endif %}>DSA</option>
                        <option value="Python/Django" {% if request.GET.category == 'Python/Django' %}selected{% endif %}>Python/Django</option>
                        <option value="ML/AI" {% if request.GET.category == 'ML/AI' %}selected{% endif %}>ML/AI</option>
                    </select>
                </div>
                    <option value="analysis" {% if request.GET.category == 'analysis' %}selected{% endif %}>Analysis</option>
                    <option value="planning" {% if request.GET.category == 'planning' %}selected{% endif %}>Planning</option>
                    <option value="testing" {% if request.GET.category == 'testing' %}selected{% endif %}>Testing</option>
                    <option value="review" {% if request.GET.category == 'review' %}selected{% endif %}>Review</option>
                    <option value="other" {% if request.GET.category == 'other' %}selected{% endif %}>Other</option>
                </select>
            </div>
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                    <select id="priority" name="priority" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Priorities</option>
                        <option value="Low" {% if request.GET.priority == 'Low' %}selected{% endif %}>Low</option>
                        <option value="Medium" {% if request.GET.priority == 'Medium' %}selected{% endif %}>Medium</option>
                        <option value="High" {% if request.GET.priority == 'High' %}selected{% endif %}>High</option>
                    </select>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status" name="status" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Status</option>
                        <option value="To Do" {% if request.GET.status == 'To Do' %}selected{% endif %}>To Do</option>
                        <option value="In Progress" {% if request.GET.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                        <option value="Completed" {% if request.GET.status == 'Completed' %}selected{% endif %}>Completed</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        <i class="fas fa-search mr-2"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Tasks Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        {% for task in tasks %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
            <!-- Task Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ task.title }}</h3>
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">{{ task.description|truncatechars:100 }}</p>
                        
                        <!-- Task Meta -->
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                <span>{{ task.day_number|default:"TBD" }}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-star mr-1"></i>
                                <span>{{ task.points }} pts</span>
                            </div>
                            {% if task.estimated_hours %}
                            <div class="flex items-center">
                                <i class="fas fa-clock mr-1"></i>
                                <span>{{ task.estimated_hours }}h</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Priority Badge -->
                    <div class="ml-4">
                        {% if task.priority == 'urgent' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Urgent
                            </span>
                        {% elif task.priority == 'high' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                <i class="fas fa-arrow-up mr-1"></i>
                                High
                            </span>
                        {% elif task.priority == 'medium' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-minus mr-1"></i>
                                Medium
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-arrow-down mr-1"></i>
                                Low
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Category and Status -->
                <div class="flex items-center justify-between mt-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        {{ task.get_category_display }}
                    </span>
                    
                    {% if task.status == 'completed' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check mr-1"></i>
                            Completed
                        </span>
                    {% elif task.status == 'in_progress' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            <i class="fas fa-spinner mr-1"></i>
                            In Progress
                        </span>
                    {% elif task.status == 'overdue' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            Overdue
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            <i class="fas fa-play mr-1"></i>
                            Not Started
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Task Actions -->
            <div class="p-6">
                <div class="flex space-x-3">
                    <a href="{% url 'tasks:task-detail' task.pk %}" class="flex-1 inline-flex justify-center items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        View Details
                    </a>
                    {% if task.status != 'completed' %}
                    <button onclick="startTask({{ task.pk }})" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        {% if task.status == 'in_progress' %}
                            Continue
                        {% else %}
                            Start
                        {% endif %}
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
            <i class="fas fa-tasks text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks found</h3>
            <p class="text-gray-600 mb-6">
                {% if request.GET.search or request.GET.category or request.GET.priority or request.GET.status %}
                    Try adjusting your filters or search terms.
                {% else %}
                    Get started by creating your first task!
                {% endif %}
            </p>
            {% if user.can_manage_tasks and not request.GET.search %}
            <a href="{% url 'tasks:task-create' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-plus mr-2"></i>
                Create First Task
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <nav class="flex items-center justify-between">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Previous
                    </a>
                {% endif %}
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Next
                    </a>
                {% endif %}
            </div>
            
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">{{ page_obj.start_index }}</span> to <span class="font-medium">{{ page_obj.end_index }}</span> of <span class="font-medium">{{ page_obj.paginator.count }}</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        {% endif %}
                        
                        {% for page_num in page_obj.paginator.page_range %}
                            {% if page_num == page_obj.number %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                                    {{ page_num }}
                                </span>
                            {% else %}
                                <a href="?page={{ page_num }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    {{ page_num }}
                                </a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </nav>
    </div>
    {% endif %}
</div>

<script>
// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    initializeViewToggle();
});

function initializeFilters() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const searchInput = document.querySelector('input[type="text"]');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-purple-100', 'text-purple-700');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            // Add active class to clicked button
            this.classList.remove('bg-gray-100', 'text-gray-700');
            this.classList.add('active', 'bg-purple-100', 'text-purple-700');
            
            // Filter tasks
            filterTasks(this.dataset.filter);
        });
    });
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            searchTasks(this.value);
        });
    }
}

function initializeViewToggle() {
    const viewButtons = document.querySelectorAll('.view-toggle');
    
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            viewButtons.forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700');
            });
            
            // Add active class to clicked button
            this.classList.remove('bg-white', 'text-gray-700');
            this.classList.add('bg-purple-600', 'text-white');
            
            // Change view
            changeView(this.dataset.view);
        });
    });
}

function filterTasks(filter) {
    const taskCards = document.querySelectorAll('[data-status]');
    
    taskCards.forEach(card => {
        const status = card.dataset.status;
        const isOverdue = card.dataset.overdue === 'true';
        
        let shouldShow = false;
        
        switch(filter) {
            case 'all':
                shouldShow = true;
                break;
            case 'todo':
                shouldShow = status === 'todo';
                break;
            case 'in_progress':
                shouldShow = status === 'in_progress';
                break;
            case 'completed':
                shouldShow = status === 'completed';
                break;
            case 'overdue':
                shouldShow = isOverdue;
                break;
        }
        
        card.style.display = shouldShow ? 'block' : 'none';
    });
}

function searchTasks(query) {
    const taskCards = document.querySelectorAll('[data-title]');
    const searchTerm = query.toLowerCase();
    
    taskCards.forEach(card => {
        const title = card.dataset.title.toLowerCase();
        const description = card.dataset.description ? card.dataset.description.toLowerCase() : '';
        
        const matches = title.includes(searchTerm) || description.includes(searchTerm);
        card.style.display = matches ? 'block' : 'none';
    });
}

function changeView(view) {
    const tasksContainer = document.querySelector('.tasks-container');
    
    switch(view) {
        case 'card':
            if (tasksContainer) {
                tasksContainer.className = 'tasks-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
            }
            break;
        case 'list':
            if (tasksContainer) {
                tasksContainer.className = 'tasks-container space-y-4';
            }
            break;
        case 'kanban':
            // Implement kanban view
            showNotification('Kanban view coming soon!', 'info');
            break;
    }
}

function startTask(taskId) {
    if (confirm('Start working on this task?')) {
        updateTaskStatus(taskId, 'in_progress');
    }
}

function completeTask(taskId) {
    if (confirm('Mark this task as completed?')) {
        updateTaskStatus(taskId, 'completed');
    }
}

function updateTaskStatus(taskId, status) {
    fetch(`/tasks/${taskId}/update-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Task status updated!', 'success');
            // Refresh the page or update the UI
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showNotification('Error updating task status', 'error');
        }
    })
    .catch(error => {
        showNotification('Network error', 'error');
    });
}

function bulkSelect() {
    // Implement bulk selection functionality
    showNotification('Bulk selection coming soon!', 'info');
}

function exportTasks() {
    window.location.href = '/tasks/export/';
}

function refreshTasks() {
    window.location.reload();
}

// Auto-submit form when sort option changes
document.addEventListener('DOMContentLoaded', function() {
    const sortSelect = document.querySelector('select[name="sort"]');
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            this.form.submit();
        });
    }
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' :
        type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' :
        'bg-blue-100 border border-blue-400 text-blue-700'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
